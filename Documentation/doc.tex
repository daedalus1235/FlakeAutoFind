\documentclass{article}
\usepackage{hw}

\title{Documentation}
\author{Charles Yang}
\date{Last updated: \today}

\begin{document}
\maketitle
\setcounter{tocdepth}{1}
\tableofcontents
\break{}
\section{General Algorithm}
The image is flattened using an infered background level. After flattening, morphological transformations are applied. Opening reduces the amount of small, white pixels, eroding reduces the size of bigger clumps of white pixels, and closing makes the flakes more solid and bold. This transformed image is then used to compute bounding boxes for flakes. The bounding boxes are then used to determine the location of the flakes on the flattened image, and the values compared to determine thickness. The final output will be the flattened and transformed image, and the original image with bounding boxes and thickness annotations.

\section{Flattening}
The symmetry of the background is assumed to that of an ellipse. Similar to a circle, where the radius is defined
\[R^2=(x-x_c)^2+(y-y_c)^2\]
we define a distance coordinate
\[s^2=(x-x_c)^2+r^2(y-y_c)^2\]
where \(r\) is the aspect ratio of the ellipse, given
\[r = \frac{\text{width}}{\text{height}}\]

In this way, we consider the background to be a function of the elliptical distance. To maintain smoothness, the background is modeled as the sum of even terms:
\begin{equation}
B_N(s)=\sum_{n=0}^N a_ns^{2n}
\end{equation}
as otherwise, the odd terms will have a discontinuity at the origin for some higher-order derivatives.

Clearly, the first \(n\) coefficients can be solved for using a system of linear equations generated by \(n\) samples of the background. This yields the equation
\[B = SA\]
where \(B\) is a vector of measured background values, \(A\) is a vector of the coefficients, and \(S\) is the Vandermonde matrix with entries \(S_{ij}=s_i^{2(j-1)}\). 



Unfortunately, only considering the lowest order (\(s^2\)) leads to inaccuracy around the borders of the image. 
\subsection{Sampling by area}
If we take samples in using the sequence
\[s^2, 2s^2, 3s^2,\dots, ns^2,\dots\]
we can factor out a vector \(s = \left[\begin{matrix} 1 & s^2 & s^{2*2} & \cdots & s^{2*n} & \cdots \end{matrix}\right]\T\)
so that
\[S=S's\]
then, we can represent the equations as the augmented matrix
\begin{equation}
	[S'\vert I]=\left[ \begin{matrix}1 & 1 & 1 & \cdots \\ 1 & 2 & 4 & \cdots\\	1 & 3 & 9 & \cdots\\ \vdots & \vdots & \vdots & \ddots \end{matrix}\,\middle\vert\,\begin{matrix}1 & 0 & 0 & \cdots \\ 0 & 1 & 0 & \cdots \\ 0 & 0 & 1 & \cdots \\ \vdots & \vdots & \vdots & \ddots\end{matrix}\right]
\end{equation}
Using row reduction, we can make the Vandermonde-coefficient matrix into an upper triangular matrix
\begin{equation}
	[T\vert C]=\left[\begin{matrix} 1 & 1 & 1 & 1 & 1 & \cdots \\
			0 & 1 & 3 & 7 & 15 &\cdots \\
			0 & 0 & 2 & 12 & 50 &\cdots \\
			0 & 0 & 0 & 6 & 30 & \cdots \\
			0 & 0 & 0 & 0 & 144 & \cdots \\
		\vdots & \vdots & \vdots & \vdots & \vdots & \ddots \end{matrix}
		\,\,\middle\vert\,\,\begin{matrix}
			1 & 0 & 0 & 0 & 0 & \cdots \\
			-1 & 1 & 0 & 0 & 0 & \cdots \\
			1 & -2 & 1 & 0 & 0 & \cdots \\
			-1 & 3 & -3 & 1 & 0 & \cdots \\
			1 & -4 & 6 & -4 & 1 & \cdots \\
			\vdots & \vdots & \vdots & \vdots & \vdots & \ddots
	\end{matrix}\right]
\end{equation}
Notice on the right side of teh augmented matrix, the \(n\)-th row of the background-coefficient matrix is the coefficients for the \((n-1)\)-th finite difference.
The following result is a trivial consequence of row reduction:
\[T=CS'\]
Substituting in
\[[T|CB]\]
as the augmented matrix, we can then use back-substitution to solve for the coefficients \(a_n\). For example, taking \(n=4\) samples yields
\[
	[CS\vert CB]=\left[\begin{matrix} 1 & 1 & 1 & 1\\
			0 & 1 & 3 & 7\\
			0 & 0 & 2 & 12\\
			0 & 0 & 0 & 6\\
		\end{matrix}
		\,\,\middle\vert\,\,\begin{matrix}
			B_1\\
			B_2-B_1\\
			B_3-B_2+B_1\\
			B_4-3B_3+3B_2-B_1\\
	\end{matrix}\right]
		\]
Thus,
\[6a_3 s^{2*3}= B_4-3B_3+3B_2-B_1\]
\[\then a_3 = \frac{B_4-3B_3+3B_2-B_1}{6s^{2*3}}\]
We can then substitute the result for \(a_3\) into the next equation
\[2a_2 s^{2*2}+12a_3s^{2*3} = B_3-B_2+B_1\]
and so forth until all of the coefficients are determined.

\subsection{Algorithm}
The initial Vandermonde-coefficent matrix can be calculated as
\[S'_{ij}=j^{i-1}\]
The rows of the background-coefficient matrix can be calculated as follows:
\[C_{1j}=(-1)^j\]
\[C_{i+1,j}=-C_{ij}*\frac{j-i}{i+1}\]
This comes from the fact that
\[C_{ij}=(-1)^{i+j}\ncr{j}{i}\]
and
\[\ncr{n}{k+1}=\ncr{n}{k}*\frac{n-k}{k+1}\]

The value of \(s^2\) is taken such that \(\sqrt{ns^2}\) is the largest ellipse that still fits on the image. 

Finally, the background values \(B_i\) are calcualted as follows. For the \(i\)-th entry, the set of all points \(\sqrt{i*s^2}\) away from the origin is generated using the midpoint ellipse rasterization algorithm. The entry \(B_i\) is then taken to be the median brighness among all of these points, as to avoid the skewing effect of very bright flakes on the mean.

These matrices are then multiplied together, and back-substitution is used to solve for the coefficients, as described in the previous section. 

Once the coefficients are determined, the background fit can be determined recursively as:
\[f_0=a_N\]
\[f_{n} =s^2f_{n-1} +a_{N-n}\]
with
\[B_N(s)=f_N\]


\section{Morphological Transformations}
\section{Bounding Boxes}
\section{Determining Thickness}
\end{document}
